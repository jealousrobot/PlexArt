## PlexArt - View all of the artwork for Plex sections at once
## Copyright (C) 2016  Jason Ellis
##
## This program is free software: you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation, either version 3 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program.  If not, see <http://www.gnu.org/licenses/>.

## Page Variables:
## plex_url - The URL of the Plex server in the format http://<server_name>:<port>
## server - The name of the Plex server
## port - The port of the Plex server
## videos - The XML containing either all of the items in the section or all of 
##          sections on the server.  Depends on the page_type.
## page_type - Used to determine what is being rendered on the page.
##   server - Sections from a server are being displayed.
##   movie  - A movie section is being displayed
##   show   - A TV show section is being displayed
##   artist - A music section is being displayed
## display_mode - Determines if the page loads with thumbnails or in a list.

<%page args="plex_url, server, port, videos='', page_type='movie'"/>
        <div id="results_container">
            <div id="results">
<% 
    priorValue = 'xx' 
%>

% for video in videos:
    <%
        video_key = video.get('ratingKey')
    %>
    
    ## Do not show photo sections, as there's no artwork to update with those  
    ## sections.
    % if video.get('type') != 'photo':
        <% 
            ## When creating the navigation section, use the sort title if it's
            ## available.
            if video.get('titleSort'):
                 currentValue = video.get('titleSort')
            else:
                 currentValue = video.get('title')
            
            video_title = video.get('title')
                
            if video.get('childCount') is None:
                childCount = 1
            else:
                childCount = int(video.get('childCount'))
                
            childCount += 1
        %>
                
        ## Items that start with a number are all grouped into the pound sign 
        ## character just like Plex
        <% 
            currentValue = currentValue[0:1] 
            if currentValue in ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']:
                currentValue = '#'
            else:
                currentValue = currentValue.upper()
        %>
        
        ## If the begining letter has changed, create a link for the new letter.
        % if priorValue != currentValue:
                <a name="${currentValue}"></a>
            <% 
                priorValue = currentValue 
            %>
        % endif
        
        ## Set variables based on what type of data is being displayed.
        ##   drawer_image - Controls wether or not the button for displaying 
        ##     the season drawer is shown.  This is only needed when processing
        ##     TV show or music sections. 
        ##   button_class - Determines which class to assign to the DIV 
        ##     surrounding the title of the movie, artist, or TV show.  Since
        ##     TV shows and artists have an extra button to show the season 
        ##     drawer the width of the DIV needs to be smaller. #}
        ##   season_class - Determines the class to assign to the DIV that shows
        ##     albums or seasons.  The hieght is different depending on what is 
        ##     being shown.  This is due to album images being square and 
        ##     seasons being rectangles.
        ##   image_name - Determines the placeholder image to show in the 
        ##     drawer.
        ##   image_height - The height of the season/album images.
        ##   video_block_class - The class for the DIV surrounding the video and
        ##     all of its elements.
        <% 
            drawer_image = '' 
            button_class = ''
            season_class = ''
            image_name = ''
            image_height = ''
            title_class = ''
                
            if page_type == 'movie' or page_type == 'server':
                drawer_image = '' 
                button_class = 'movie'
                season_class = ''
                image_name = ''
                image_height = '150'
                video_block_class = ''
                title_class = 'video_title2_movie'
            else:
                drawer_image = '<img id="drawer-' + video.get('ratingKey') + '" src="static/images/arrow.png" class="video_drawer" width="20" height="20">'
                button_class = 'tv'
                title_class = 'video_title2_tv'
            
                ## A placeholder image for a season/album needs to be created.  
                ## This allows for the drawer to be sized correctly during the
                ## page load process and allows for smoother animation when the 
                ## drawer is opened. Different images and classes are needed 
                ## for albums or seasons since one is 100 pixels tall and the 
                ## other is 150. 
                if page_type == 'show':
                    season_class = 'season_block_tv'
                    image_name = 'emptyTVThumb.jpg'
                    image_height = '150'
            
                if page_type == 'artist':
                    season_class = 'season_block_music'
                    image_name = 'emptyMusicThumb.jpg'
                    image_height = '100'
                    
            if display_mode == 'list':
              title_class = 'video_title2_list'
                
            if page_type != 'server':    
                if display_mode == 'thumbs':
                    video_block_class = ''
                    hide_details = 'style="display:none;"'
                else:
                    video_block_class = 'list_'
                    hide_details = ''
        %>
        
        ## If the page_type is a server, output the images for the
        ## different sections.
        % if page_type == 'server':
                <div class="item_block">
                    <div class="item_image" id="image-${video.get('key')}"><a class="item_link" href="../section?server=${server}&port=${port}&key=${video.get('key')}&section=${video_title}"><img src="${plex_url}${video.get('art')}" width="267" height="150"></a></div>
                    <div class="item_title" id="title-${video.get('key')}"><a class="item_link" href="../section?server=${server}&port=${port}&key=${video.get('key')}&section=${video_title}">${video_title}</a></div>
                </div>
        ## For all other page_type values, this is a section in Plex.  Output 
        ## the images for the videos in the section.
        % else:
                <div class="${video_block_class}video_block" id="block-${video.get('ratingKey')}">
                    <div class="video_img" id="image-${video.get('ratingKey')}"><img id="thumb-${video.get('ratingKey')}" class="video_thumb ${video_key}" src="${plex_url}${video.get('thumb')}" width="100" height="${image_height}"><img id="art-${video.get('ratingKey')}" class="${video_key}" src="${plex_url}${video.get('art')}" width="267" height="150">
            <%
                def process_list( list_name):
                    list_out = ''
                    list = lists[list_name]
                    
                    for key in list:
                        if key == video.get('ratingKey'):
                            for list_item in list[key]:
                                if not list_out:
                                    list_out = list_item
                                else:
                                    list_out = list_out + ' / ' + list_item
                     
                    if not list_out:
                        list_out = 'None'
                         
                    return list_out
                                
                genre_out = process_list('genre')
                collection_out = process_list('collection')
                playlist_out = process_list('playlist')
                
            %>
                    <div class="list_details" id="list_details-${video.get('ratingKey')}" ${hide_details}>
                        <div class="list_genre" id="list_genre-${video.get('ratingKey')}">
                            <div class="list_title">Genres:</div>
                            <div class="list_item ${video_key}" id="list_item_genre-${video.get('ratingKey')}">${genre_out}</div>
                        </div>
                        <div class="list_collection" id="list_collection-${video.get('ratingKey')}">
                            <div class="list_title">Collections:</div>
                            <div class="list_item ${video_key}" id="list_item_collection-${video.get('ratingKey')}">${collection_out}</div>
                        </div>
                        <div class="list_playlist" id="list_playlist-${video.get('ratingKey')}">
                            <div class="list_title">Playlists:</div>
                            <div class="list_item"id="list_item_playlist-${video.get('ratingKey')}">${playlist_out}</div>
                        </div>
                    </div>
                </div>
                    <div class="${video_block_class}video_title" id="title-${video.get('ratingKey')}"><div class="video_title2 ${title_class}">${video_title}</div><div class="refresh refresh_${button_class}">${drawer_image}<img id="refresh-${video.get('ratingKey')}" class="video_refresh" src="static/images/refresh.png" width="20" height="20" alt="Refresh Artwork"></div></div>
                    
            % if page_type == 'show' or page_type == 'artist':
                    <div class="seasons" id="season-${video.get('ratingKey')}">
                <%
                    seasonHTML = ''
                    for i in range(1,childCount):
                        seasonHTML += '<div class="' + season_class + ' jason' + str(childCount) + '">'
                        seasonHTML += '    <div class="season">'
                        seasonHTML += '        <div class="season_img"><img src="/static/images/' + image_name + '" width="100" height="' + image_height + '"></div>'
                        seasonHTML += '        <div class="season_title">Title</div>'
                        seasonHTML += '    </div>'
                        seasonHTML += '</div>'
                %>
${seasonHTML}
                    </div>
            % endif
                </div>
        % endif 
    % endif
% endfor

            </div>
        </div>